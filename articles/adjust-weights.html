<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adjusting annual weights • piar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adjusting annual weights">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">piar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.1.9025</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/piar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/multiple-baskets.html">Aggregating across baskets</a></li>
    <li><a class="dropdown-item" href="../articles/multiple-dimensions.html">Aggregating across dimensions</a></li>
    <li><a class="dropdown-item" href="../articles/matrix-aggregation.html">Matrix aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/superlative-aggregation.html">Superlative aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/subperiods.html">Aggregating over subperiods</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marberts/piar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Adjusting annual weights</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marberts/piar/blob/main/vignettes/adjust-weights.Rmd" class="external-link"><code>vignettes/adjust-weights.Rmd</code></a></small>
      <div class="d-none name"><code>adjust-weights.Rmd</code></div>
    </div>

    
    
<p>Making a monthly or quarterly Lowe index with annual expenditure or
revenue weights requires adjusting these weights so that the implicit
annual quantity vector is used as the fixed basket when making the index
with the usual two-step procedure. This can be done by price updating
the annual weights to the base period of the index, and it serves as a
good example of extending the functions in this package.</p>
<p>Let’s start by making some annual weights and quarterly indexes for a
year.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marberts.github.io/piar/">piar</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make an aggregation structure.</span></span>
<span><span class="co">#                  1</span></span>
<span><span class="co">#      |-----------|-----------|</span></span>
<span><span class="co">#      11          12          13</span></span>
<span><span class="co">#  |---+---|   |---+---|   |---+---|</span></span>
<span><span class="co"># 111     121 121     122 131     132</span></span>
<span></span>
<span><span class="va">pias</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  level1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>  level2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">12</span>, <span class="fl">13</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  level3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">111</span>, <span class="fl">112</span>, <span class="fl">121</span>, <span class="fl">122</span>, <span class="fl">131</span>, <span class="fl">132</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  ea <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"B%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  weight <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_aggregation_structure.html">as_aggregation_structure</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pias</span></span></code></pre></div>
<pre><code><span><span class="co">## Aggregation structure for 12 elemental aggregates with 3 levels above the elemental aggregates </span></span>
<span><span class="co">##    level1 level2 level3  ea weight</span></span>
<span><span class="co">## 1       1     11    111 B01      1</span></span>
<span><span class="co">## 2       1     11    111 B02      2</span></span>
<span><span class="co">## 3       1     11    112 B03      3</span></span>
<span><span class="co">## 4       1     11    112 B04      4</span></span>
<span><span class="co">## 5       1     12    121 B05      5</span></span>
<span><span class="co">## 6       1     12    121 B06      6</span></span>
<span><span class="co">## 7       1     12    122 B07      7</span></span>
<span><span class="co">## 8       1     12    122 B08      8</span></span>
<span><span class="co">## 9       1     13    131 B09      9</span></span>
<span><span class="co">## 10      1     13    131 B10     10</span></span>
<span><span class="co">## 11      1     13    132 B11     11</span></span>
<span><span class="co">## 12      1     13    132 B12     12</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make elemental indexes over 4 quarters.</span></span>
<span><span class="va">elementals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">12</span> <span class="op">*</span> <span class="fl">4</span>, <span class="fl">0.4</span>, <span class="fl">1.2</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"B%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Q"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_index.html">as_index</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elementals</span></span></code></pre></div>
<pre><code><span><span class="co">## Period-over-period price index for 12 levels over 4 time periods </span></span>
<span><span class="co">##            Q1        Q2        Q3        Q4</span></span>
<span><span class="co">## B01 0.7432063 0.4362399 1.1441564 1.1277327</span></span>
<span><span class="co">## B02 0.7987443 0.9221768 0.8326890 0.9997250</span></span>
<span><span class="co">## B03 0.5413539 1.1952528 0.9594449 1.0966120</span></span>
<span><span class="co">## B04 0.6195148 0.9421099 1.0672886 0.8581942</span></span>
<span><span class="co">## B05 0.5732081 1.1348361 0.4098346 1.1227607</span></span>
<span><span class="co">## B06 1.0930889 0.7699560 1.1682339 0.5616191</span></span>
<span><span class="co">## B07 0.4395281 0.8571318 0.9445658 0.9494140</span></span>
<span><span class="co">## B08 0.5673079 0.7615511 0.4677992 0.7279183</span></span>
<span><span class="co">## B09 0.6732899 0.5341656 1.1756704 1.1541544</span></span>
<span><span class="co">## B10 0.6973270 0.4546091 0.4928318 0.8646791</span></span>
<span><span class="co">## B11 0.5093139 1.1175286 1.1014889 0.8980850</span></span>
<span><span class="co">## B12 0.9408381 0.6190696 0.7101399 1.1024539</span></span></code></pre>
<p>Adjusting the weights is simple when there are no missing elemental
indexes: the weight for each elemental aggregate is just divided by the
average (fixed-base) index for each quarter.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="va">elementals</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       B01       B02       B03       B04       B05       B06       B07       B08 </span></span>
<span><span class="co">##  2.154344  2.896610  4.819251  6.777709 11.175522  6.916156 18.543541 23.728960 </span></span>
<span><span class="co">##       B09       B10       B11       B12 </span></span>
<span><span class="co">## 18.520664 30.635776 19.396354 20.059400</span></span></code></pre>
<p>The procedure is more complicated with missing elemental indexes as
reaggregating these indexes with the newly adjusted weights will
generally result in different imputations for the missing elemental
indexes, which in turn gives a different adjustment for the weights. In
practice this procedure is done a few times until the index values
converge to a fixed point. The following function shows how to do this
adjustment using the tools in this package.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to adjust annual weights.</span></span>
<span><span class="va">adjust_weights</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span>,</span>
<span>                           <span class="va">pias</span>,</span>
<span>                           <span class="va">tol</span> <span class="op">=</span> <span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">^</span><span class="fl">0.5</span>,</span>
<span>                           <span class="va">max_iter</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">adj_pias</span> <span class="op">&lt;-</span> <span class="va">pias</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">max_iter</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Parentally impute missing elemental indexes.</span></span>
<span>    <span class="va">agg_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">index</span>, <span class="va">adj_pias</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, contrib <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">elementals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="va">agg_index</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/nlevels.html" class="external-link">nlevels</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># Compute annual elemental indexes.</span></span>
<span>    <span class="va">pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">elementals</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># Stop if average price-update weights are within tolerance of original</span></span>
<span>    <span class="co"># weights; adjust otherwise.</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">pb</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">adj_pias</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">tol</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">gettextf</a></span><span class="op">(</span><span class="st">"Converged after %d iterations"</span>, <span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">adj_pias</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">adj_pias</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weights.html" class="external-link">weights</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span> <span class="op">/</span> <span class="va">pb</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"weights adjustment did not converge"</span><span class="op">)</span></span>
<span>  <span class="va">adj_pias</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elementals</span><span class="op">[</span><span class="fl">11</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu">adjust_weights</span><span class="op">(</span><span class="va">elementals</span>, <span class="va">pias</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Converged after 2 iterations</span></span></code></pre>
<pre><code><span><span class="co">## Aggregation structure for 12 elemental aggregates with 3 levels above the elemental aggregates </span></span>
<span><span class="co">##    level1 level2 level3  ea    weight</span></span>
<span><span class="co">## 1       1     11    111 B01  2.154344</span></span>
<span><span class="co">## 2       1     11    111 B02  2.896610</span></span>
<span><span class="co">## 3       1     11    112 B03  4.819251</span></span>
<span><span class="co">## 4       1     11    112 B04  6.777709</span></span>
<span><span class="co">## 5       1     12    121 B05 11.175522</span></span>
<span><span class="co">## 6       1     12    121 B06  6.916156</span></span>
<span><span class="co">## 7       1     12    122 B07 18.543541</span></span>
<span><span class="co">## 8       1     12    122 B08 23.728960</span></span>
<span><span class="co">## 9       1     13    131 B09 18.520664</span></span>
<span><span class="co">## 10      1     13    131 B10 30.635776</span></span>
<span><span class="co">## 11      1     13    132 B11 28.458991</span></span>
<span><span class="co">## 12      1     13    132 B12 31.046172</span></span></code></pre>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
