<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Matrix aggregation • piar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Matrix aggregation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">piar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.3.9001</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/piar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/multiple-baskets.html">Aggregating across baskets</a></li>
    <li><a class="dropdown-item" href="../articles/multiple-dimensions.html">Aggregating across dimensions</a></li>
    <li><a class="dropdown-item" href="../articles/matrix-aggregation.html">Matrix aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/superlative-aggregation.html">Superlative aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/subperiods.html">Aggregating over subperiods</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marberts/piar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Matrix aggregation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marberts/piar/blob/main/vignettes/matrix-aggregation.Rmd" class="external-link"><code>vignettes/matrix-aggregation.Rmd</code></a></small>
      <div class="d-none name"><code>matrix-aggregation.Rmd</code></div>
    </div>

    
    
<p>Aggregating a price index can be done as a matrix operation. Although
this approach is less flexible than the <code><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate()</a></code> method
used in <code><a href="../articles/piar.html">vignette("piar")</a></code> (i.e., there can be no missing
elementary indexes), it can be considerably faster for larger
indexes.</p>
<p>Let’s start by building the index in <code><a href="../articles/piar.html">vignette("piar")</a></code>
again.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marberts.github.io/piar/">piar</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make an aggregation structure.</span></span>
<span><span class="va">ms_weights</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"level1"</span>, <span class="st">"level2"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/expand_classification.html">expand_classification</a></span><span class="op">(</span><span class="va">ms_weights</span><span class="op">$</span><span class="va">classification</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pias</span> <span class="op">&lt;-</span> <span class="va">ms_weights</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"level1"</span>, <span class="st">"level2"</span>, <span class="st">"business"</span>, <span class="st">"weight"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_aggregation_structure.html">as_aggregation_structure</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a fixed-base index.</span></span>
<span><span class="va">elementals</span> <span class="op">&lt;-</span> <span class="va">ms_prices</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span></span>
<span>    relative <span class="op">=</span> <span class="fu"><a href="../reference/price_relative.html">price_relative</a></span><span class="op">(</span><span class="va">price</span>, period <span class="op">=</span> <span class="va">period</span>, product <span class="op">=</span> <span class="va">product</span><span class="op">)</span>,</span>
<span>    business <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">business</span>, levels <span class="op">=</span> <span class="va">ms_weights</span><span class="op">$</span><span class="va">business</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/elementary_index.html">elementary_index</a></span><span class="op">(</span><span class="va">relative</span> <span class="op">~</span> <span class="va">period</span> <span class="op">+</span> <span class="va">business</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="va">elementals</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">pias</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">index</span></span></code></pre></div>
<pre><code><span><span class="co">## Fixed-base price index for 8 levels over 4 time periods </span></span>
<span><span class="co">##       time</span></span>
<span><span class="co">## levels 202001    202002    202003    202004</span></span>
<span><span class="co">##     1       1 1.3007239 1.3827662 3.7815355</span></span>
<span><span class="co">##     11      1 1.3007239 1.3827662 2.1771866</span></span>
<span><span class="co">##     12      1 1.3007239 1.3827662 6.3279338</span></span>
<span><span class="co">##     B1      1 0.8949097 0.2991629 0.4710366</span></span>
<span><span class="co">##     B2      1 1.3007239 1.3827662 3.8308934</span></span>
<span><span class="co">##     B3      1 2.0200036 3.3033836 1.7772072</span></span>
<span><span class="co">##     B4      1 1.3007239 1.3827662 6.3279338</span></span>
<span><span class="co">##     B5      1 1.3007239 1.3827662 6.3279338</span></span></code></pre>
<p>The key to do this aggregation as a matrix operation is to first turn
the aggregation structure into an aggregation matrix.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pias_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pias_matrix</span></span></code></pre></div>
<pre><code><span><span class="co">##       </span></span>
<span><span class="co">## levels        B1        B2        B3        B4        B5</span></span>
<span><span class="co">##     1  0.2245229 0.2622818 0.1266748 0.2525376 0.1339829</span></span>
<span><span class="co">##     11 0.3659828 0.4275314 0.2064858 0.0000000 0.0000000</span></span>
<span><span class="co">##     12 0.0000000 0.0000000 0.0000000 0.6533613 0.3466387</span></span></code></pre>
<p>Multiplying this matrix with a matrix of fixed-base elementary
indexes now computes the aggregate index in each time period.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pias_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">index</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span><span class="op">$</span><span class="va">business</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       time</span></span>
<span><span class="co">## levels 202001   202002   202003   202004</span></span>
<span><span class="co">##     1       1 1.300724 1.382766 3.781536</span></span>
<span><span class="co">##     11      1 1.300724 1.382766 2.177187</span></span>
<span><span class="co">##     12      1 1.300724 1.382766 6.327934</span></span></code></pre>
<div class="section level2">
<h2 id="computing-the-shadow-of-an-index">Computing the shadow of an index<a class="anchor" aria-label="anchor" href="#computing-the-shadow-of-an-index"></a>
</h2>
<p>It’s often useful to determine which higher-level index values are
missing, and subsequently get imputed during aggregation (i.e., compute
the shadow of an index). This is simple to do if there’s an elementary
index for each elementary aggregate in the aggregation structure.</p>
<p>The idea is to aggregate an indicator for missingness to get a matrix
that gives the share of missing elementary indexes for each higher-level
index.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pias_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">pias_matrix</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">elementals</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">pias_matrix</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       time</span></span>
<span><span class="co">## levels 202001    202002    202003    202004</span></span>
<span><span class="co">##     1     0.4 0.6000000 0.6000000 0.4000000</span></span>
<span><span class="co">##     11    0.0 0.3333333 0.3333333 0.3333333</span></span>
<span><span class="co">##     12    1.0 1.0000000 1.0000000 0.5000000</span></span></code></pre>
<p>A value of 1 means that there are no non-missing elementary indexes,
and that the value for this level of the index is imputed from its
parent in the aggregation structure. A value below 1 but above zero
means that some but not all elementary indexes are missing, and the
index value for this level is based on the non-missing elementary
indexes. A value of zero means there’s no imputation for this level of
the index.</p>
</div>
<div class="section level2">
<h2 id="sparse-matrices">Sparse matrices<a class="anchor" aria-label="anchor" href="#sparse-matrices"></a>
</h2>
<p>Aggregation structures are naturally sparse. Although using a dense
aggregation matrix does not matter for small indexes, it quickly becomes
inefficient for large indexes—in this case it is better to make a sparse
aggregation matrix.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pias</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 3 x 5 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##       </span></span>
<span><span class="co">## levels        B1        B2        B3        B4        B5</span></span>
<span><span class="co">##     1  0.2245229 0.2622818 0.1266748 0.2525376 0.1339829</span></span>
<span><span class="co">##     11 0.3659828 0.4275314 0.2064858 .         .        </span></span>
<span><span class="co">##     12 .         .         .         0.6533613 0.3466387</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
