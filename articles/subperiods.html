<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Aggregating over subperiods • piar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregating over subperiods">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">piar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.1.9019</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/piar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/multiple-baskets.html">Aggregating across baskets</a></li>
    <li><a class="dropdown-item" href="../articles/multiple-dimensions.html">Aggregating across dimensions</a></li>
    <li><a class="dropdown-item" href="../articles/matrix-aggregation.html">Matrix aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/superlative-aggregation.html">Superlative aggregation</a></li>
    <li><a class="dropdown-item" href="../articles/subperiods.html">Aggregating over subperiods</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/marberts/piar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Aggregating over subperiods</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marberts/piar/blob/main/vignettes/subperiods.Rmd" class="external-link"><code>vignettes/subperiods.Rmd</code></a></small>
      <div class="d-none name"><code>subperiods.Rmd</code></div>
    </div>

    
    
<p>With the exception of <code><a href="../articles/spatial-price-index.html">vignette("spatial-price-index")</a></code>,
all the examples so far have revolved around aggregating over the levels
of a price index for each time period. Although this is the core
workflow in this package, it is also useful to be able to aggregate over
the time periods for each level of an index to turn a monthly or
quarterly index into an annual index.</p>
<p>Let’s modify the example in <code><a href="../articles/adjust-weights.html">vignette("adjust-weights")</a></code>
by adding an additional eight quarters to make three years of data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marberts.github.io/piar/">piar</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make an aggregation structure.</span></span>
<span><span class="co">#                  1</span></span>
<span><span class="co">#      |-----------|-----------|</span></span>
<span><span class="co">#      11          12          13</span></span>
<span><span class="co">#  |---+---|   |---+---|   |---+---|</span></span>
<span><span class="co"># 111     121 121     122 131     132</span></span>
<span></span>
<span><span class="va">pias</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  level1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>,</span>
<span>  level2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">12</span>, <span class="fl">13</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  level3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">111</span>, <span class="fl">112</span>, <span class="fl">121</span>, <span class="fl">122</span>, <span class="fl">131</span>, <span class="fl">132</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  ea <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"B%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>  weight <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_aggregation_structure.html">as_aggregation_structure</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pias</span></span></code></pre></div>
<pre><code><span><span class="co">## Aggregation structure for 12 elemental aggregates with 3 levels above the elemental aggregates </span></span>
<span><span class="co">##    level1 level2 level3  ea weight</span></span>
<span><span class="co">## 1       1     11    111 B01      1</span></span>
<span><span class="co">## 2       1     11    111 B02      2</span></span>
<span><span class="co">## 3       1     11    112 B03      3</span></span>
<span><span class="co">## 4       1     11    112 B04      4</span></span>
<span><span class="co">## 5       1     12    121 B05      5</span></span>
<span><span class="co">## 6       1     12    121 B06      6</span></span>
<span><span class="co">## 7       1     12    122 B07      7</span></span>
<span><span class="co">## 8       1     12    122 B08      8</span></span>
<span><span class="co">## 9       1     13    131 B09      9</span></span>
<span><span class="co">## 10      1     13    131 B10     10</span></span>
<span><span class="co">## 11      1     13    132 B11     11</span></span>
<span><span class="co">## 12      1     13    132 B12     12</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make elemental indexes over 3 years and aggregate.</span></span>
<span><span class="va">quarterly_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">12</span> <span class="op">*</span> <span class="fl">12</span>, <span class="fl">0.4</span>, <span class="fl">1.2</span><span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"B%02d"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Q"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_index.html">as_index</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">pias</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">quarterly_index</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Period-over-period price index for 6 levels over 12 time periods </span></span>
<span><span class="co">##            Q1        Q2        Q3        Q4        Q5        Q6        Q7</span></span>
<span><span class="co">## 1   0.6847172 0.7513116 0.8602744 0.9150072 0.6691529 0.7621597 0.7928512</span></span>
<span><span class="co">## 11  0.6442816 0.9426238 0.9800151 0.9787698 0.9366504 0.8698449 0.8068903</span></span>
<span><span class="co">## 12  0.6553744 0.8448298 0.7877433 0.7364719 0.6864661 0.6092876 0.5790867</span></span>
<span><span class="co">## 13  0.7125093 0.6568730 0.8763973 1.0105002 0.5713334 0.7912029 0.8792723</span></span>
<span><span class="co">## 111 0.7802316 0.7678844 0.8888722 1.0294469 0.9856799 1.0533765 1.1007037</span></span>
<span><span class="co">## 112 0.5860173 1.0423311 1.0183284 0.9601751 0.9173623 0.7922671 0.6417663</span></span>
<span><span class="co">##            Q8        Q9       Q10       Q11       Q12</span></span>
<span><span class="co">## 1   0.9285013 0.7802293 0.8192686 0.7150868 0.9343166</span></span>
<span><span class="co">## 11  1.0502027 0.8297739 0.9545600 0.7823591 0.8891911</span></span>
<span><span class="co">## 12  0.7510670 1.0351129 0.6936704 0.5073677 0.7432221</span></span>
<span><span class="co">## 13  0.9130143 0.6873897 0.7607797 0.7188072 1.0262155</span></span>
<span><span class="co">## 111 1.1442371 0.7836807 1.0508585 0.5157759 1.1069026</span></span>
<span><span class="co">## 112 0.9595630 0.8827540 0.8562962 1.1161902 0.7632120</span></span></code></pre>
<p>The conventional way to turn a quarterly arithmetic index into an
annual one is to take the (unweighted) arithmetic mean of the index
values over each year and rebase to a new base year.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">annual_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chain.html">chain</a></span><span class="op">(</span><span class="va">quarterly_index</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span>window <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">annual_index</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/chain.html">rebase</a></span><span class="op">(</span><span class="st">"Q1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Fixed-base price index for 6 levels over 3 time periods </span></span>
<span><span class="co">##     Q1        Q5         Q9</span></span>
<span><span class="co">## 1    1 0.3875906 0.17112143</span></span>
<span><span class="co">## 11   1 0.7431798 0.46232765</span></span>
<span><span class="co">## 12   1 0.2497373 0.07096693</span></span>
<span><span class="co">## 13   1 0.3687070 0.14792335</span></span>
<span><span class="co">## 111  1 0.9971250 0.72915914</span></span>
<span><span class="co">## 112  1 0.6323628 0.34588738</span></span></code></pre>
<p>It’s worth not that, at least with an arithmetic index, the
aggregation properties of the index continue to hold after
price-updating the weights.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">annual_pias</span> <span class="op">&lt;-</span> <span class="va">pias</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span><span class="va">annual_index</span>, period <span class="op">=</span> <span class="st">"Q1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">annual_index</span> <span class="op">&lt;-</span> <span class="va">annual_index</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/chain.html">rebase</a></span><span class="op">(</span><span class="st">"Q1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">annual_index</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">annual_pias</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">annual_index</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>This means that, for example, the workflow in
<code><a href="../articles/contributions.html">vignette("contributions")</a></code> for determining, say, the
quarter-over-quarter contribution of the level 2 indexes to top-level
index remains the same.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reuse the reset_contrib() function from the other vignette.</span></span>
<span><span class="va">reset_contrib</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">contrib_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/contrib.html">contrib</a></span><span class="op">(</span><span class="va">index</span>, <span class="va">l</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">contrib_matrix</span><span class="op">[</span><span class="va">l</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">index</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">annual_index</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/chain.html">unchain</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">reset_contrib</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">annual_pias</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/contrib.html">contrib</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Q1          Q5         Q9</span></span>
<span><span class="co">## 11  0 -0.03908184 -0.1102682</span></span>
<span><span class="co">## 12  0 -0.24028499 -0.1477187</span></span>
<span><span class="co">## 13  0 -0.33304262 -0.3005126</span></span></code></pre>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
